(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{121:function(e,t,a){e.exports=a(234)},139:function(e,t,a){},142:function(e,t,a){},166:function(e,t,a){},168:function(e,t,a){},169:function(e,t,a){},170:function(e,t,a){},171:function(e,t,a){},230:function(e,t,a){e.exports=a.p+"static/media/logo-combined.4f7ebe9c.png"},231:function(e,t,a){e.exports=a.p+"static/media/exit.dd457aba.png"},232:function(e){e.exports={}},233:function(e){e.exports={}},234:function(e,t,a){"use strict";a.r(t);var n=a(0),r=a.n(n),c=a(25),s=a.n(c),o=a(9),i=a.n(o),l=a(13),u=a(15),p=a(16),m=a(18),h=a(17),f=a(19),d=a(236),g=a(237),v=a(238),b=a(55),y=a.n(b),w=(a(139),function(){return r.a.createElement(d.a,{fluid:!0,className:"waiter h-100 w-100 p-0 m-0 text-center"},r.a.createElement(g.a,{className:"h-100 w-100 p-0 m-0 align-items-center"},r.a.createElement(v.a,null,r.a.createElement(y.a,{color:"gray",size:10}))))}),E=a(58),x=a(239),k=(a(142),"https://cors-anywhere.herokuapp.com/https://megapolis.bpium.ru/auth/login"),O=function(e){return j.apply(this,arguments)};function j(){return(j=Object(l.a)(i.a.mark(function e(t){var a;return i.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,fetch(k,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});case 2:return a=e.sent,e.abrupt("return",a);case 4:case"end":return e.stop()}},e)}))).apply(this,arguments)}var N=function(e){function t(){var e,a;Object(u.a)(this,t);for(var n=arguments.length,r=new Array(n),c=0;c<n;c++)r[c]=arguments[c];return(a=Object(m.a)(this,(e=Object(h.a)(t)).call.apply(e,[this].concat(r)))).state={authFailed:!1,waiting:!1},a}return Object(f.a)(t,e),Object(p.a)(t,[{key:"sendAuthRequest",value:function(){var e=Object(l.a)(i.a.mark(function e(t){var a;return i.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.setState({waiting:!0}),e.next=3,O(t);case 3:a=e.sent,this.setState({waiting:!1}),console.log(a),200===a.status?(this.setState({authFailed:!1}),this.props.onAuthSuccess(t)):401===a.status&&this.setState({authFailed:!0});case 7:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"onFormSubmit",value:function(e){this.state.waiting||this.sendAuthRequest(e)}},{key:"render",value:function(){var e=this;return r.a.createElement(d.a,{fluid:!0,className:"auth h-100 w-100 p-0 m-0"},r.a.createElement(g.a,{className:"flex-column h-100 w-100 p-0 m-0 align-items-center justify-content-center"},r.a.createElement(E.a,{onSubmit:function(t){return e.onFormSubmit(t)},initialValues:{}},r.a.createElement(v.a,{className:"px-0"},r.a.createElement("label",null,r.a.createElement(v.a,{className:"px-0 mb-1"},"\u041b\u043e\u0433\u0438\u043d"),r.a.createElement(v.a,{className:"email px-0"},r.a.createElement(E.b,{field:"email",type:"email"})))),r.a.createElement(v.a,{className:"px-0"},r.a.createElement("label",null,r.a.createElement(v.a,{className:"px-0 mb-1"},"\u041f\u0430\u0440\u043e\u043b\u044c"),r.a.createElement(v.a,{className:"password px-0"},r.a.createElement(E.b,{field:"password",type:"password"})))),r.a.createElement(v.a,{className:"warning px-0"},this.state.authFailed?"\u041d\u0435\u0432\u0435\u0440\u043d\u044b\u0439 \u043b\u043e\u0433\u0438\u043d \u0438\u043b\u0438 \u043f\u0430\u0440\u043e\u043b\u044c":""),r.a.createElement(v.a,{className:"px-0"},r.a.createElement(x.a,{variant:"success",type:"submit"},this.state.waiting?r.a.createElement(y.a,{size:7,color:"rgba(255,255,255,0.7)"}):"\u0412\u043e\u0439\u0442\u0438")))))}}]),t}(r.a.Component),S=a(113),C=a.n(S),F=a(114),I=a.n(F),D=a(32),A=a.n(D),M=(a(166),{1:{name:"\u0412\u044b\u0441\u043e\u043a\u0430\u044f",color:"rgba(203, 60, 62, 0.8)",colorMuted:"rgba(240, 201, 202, 0.8)"},2:{name:"\u0421\u0440\u0435\u0434\u043d\u044f\u044f",color:"rgba(255, 147, 15, 0.8)",colorMuted:"rgba(255, 226, 190, 0.8)"},3:{name:"\u041d\u0438\u0437\u043a\u0430\u044f",color:"rgba(81, 175, 43, 0.8)",colorMuted:"rgba(208, 251, 191, 0.8)"},4:{name:"\u041f\u043b\u0430\u043d\u043e\u0432\u0430\u044f",color:"rgba(84, 213, 255, 0.8)",colorMuted:"rgba(213, 245, 255, 0.8)"},default:{name:"\u0412 \u043f\u043e\u0440\u044f\u0434\u043a\u0435",color:"rgba(99, 99, 99, 0.7)",colorMuted:"rgba(200, 200, 200, 0.7)"}});var T=function(e){var t=[];e.points.forEach(function(e){e.applications.forEach(function(e){t.push(e.criticality)})});var a=t.length?+function(e){var t={};e.forEach(function(e){t[e]?t[e]++:t[e]=1});var a,n=0;for(var r in t)t[r]>n&&(n=t[r],a=r);return a}(t):null,n=t.length,c=20+2*n;c>100&&(c=100);var s=null!==a?M[a].color:M.default.colorMuted;return r.a.createElement(A.a,{className:"cluster px-0 justify-content-center align-items-center",style:{height:c,width:c,marginTop:-c/2,marginLeft:-c/2,backgroundColor:s}},r.a.createElement("span",{className:"title"},n))},R=(a(168),function(e){function t(){var e,a;Object(u.a)(this,t);for(var n=arguments.length,r=new Array(n),c=0;c<n;c++)r[c]=arguments[c];return(a=Object(m.a)(this,(e=Object(h.a)(t)).call.apply(e,[this].concat(r)))).state={clusters:[]},a.mapOptions={center:t.defaultProps.center,zoom:t.defaultProps.zoom},a.onMapChange=function(e){a.mapOptions=e;var n=a.props.data?a.props.data:[],r=t.createClusters(a.mapOptions,n);a.setState({clusters:r})},a}return Object(f.a)(t,e),Object(p.a)(t,[{key:"componentDidUpdate",value:function(e){e.data!==this.props.data&&this.onMapChange(this.mapOptions)}},{key:"render",value:function(){var e=this.state.clusters.map(function(e){return r.a.createElement(T,{key:e.id,lat:e.lat,lng:e.lng,points:e.points})});return r.a.createElement(A.a,{fluid:!0,className:"map h-100 w-100 px-0"},r.a.createElement(C.a,{bootstrapURLKeys:{language:"ru",region:"ru"},defaultCenter:t.defaultProps.center,defaultZoom:t.defaultProps.zoom,onChange:this.onMapChange,options:function(){return{disableDefaultUI:!0}}},e))}}],[{key:"createClusters",value:function(e,t){return I()(t)(e).map(function(e){var t=e.wx,a=e.wy,n=e.numPoints,r=e.points;return{lat:a,lng:t,numPoints:n,id:"".concat(n,"_").concat(r[0].id),points:r}})}}]),t}(r.a.Component));R.defaultProps={center:{lat:61.25,lng:73.38},zoom:4};a(169);var P=a(115),_=a.n(P),B=(a(170),function(e){function t(){return Object(u.a)(this,t),Object(m.a)(this,Object(h.a)(t).apply(this,arguments))}return Object(f.a)(t,e),Object(p.a)(t,[{key:"render",value:function(){return r.a.createElement(_.a,{className:"Frame m-0",style:{paddingTop:this.props.view.FRAME_PY,paddingBottom:this.props.view.FRAME_PY,paddingRight:this.props.view.FRAME_PX,paddingLeft:this.props.view.FRAME_PX}},r.a.createElement(A.a,{fluid:!0,className:"p-0 m-0 h-100 w-100"},r.a.createElement("div",{className:"iframe-container"},r.a.createElement("div",{onClick:this.props.closeFrame,className:"close-button"},"\u2715"),r.a.createElement("iframe",{width:"100%",height:"100%",src:"https://megapolis.bpium.ru/?action=record-open&catalog=12&record=".concat(this.props.recordId,"&screen=full")}))))}}]),t}(r.a.Component)),L=(a(171),a(79)),z=[];for(var H in M)z.push({key:H,info:M[H],selected:!0});var q=function(e){function t(){var e,a;Object(u.a)(this,t);for(var n=arguments.length,r=new Array(n),c=0;c<n;c++)r[c]=arguments[c];return(a=Object(m.a)(this,(e=Object(h.a)(t)).call.apply(e,[this].concat(r)))).state={filterTitles:z,stopIndex:null,startIndex:null},a.changeFilters=function(){var e={criticality:[]};a.state.filterTitles.forEach(function(t){t.selected&&e.criticality.push(t.key)}),a.props.filterData(e)},a.toggleFilterSelect=function(e){var t=a.state.filterTitles.slice();t[e].selected=!t[e].selected,a.setState({filterTitles:t}),a.changeFilters()},a.blurerHeight=10,a}return Object(f.a)(t,e),Object(p.a)(t,[{key:"componentDidMount",value:function(){this.hardcodeBlurBottomCorner()}},{key:"hardcodeBlurBottomCorner",value:function(){var e=this.refs.bottomBlurer,t=e.getContext("2d"),a=t.createLinearGradient(0,0,0,e.height);a.addColorStop(0,"rgba(255,255,255,0)"),a.addColorStop(1,"rgba(255,255,255,0.8)"),t.fillStyle=a,t.fillRect(0,0,this.props.view.LIST_WIDTH,e.height)}},{key:"render",value:function(){var e=this,t=this.state.filterTitles.map(function(t,a){return r.a.createElement(J,{key:t.info.name,title:t.info.name,color:t.info.color,colorMuted:t.info.colorMuted,selected:t.selected,index:a,toggleFilterSelect:e.toggleFilterSelect})}),n=this.props.data.length-this.state.stopIndex-1;return r.a.createElement(d.a,{className:"List h-100 px-0 mx-0",style:{width:this.props.view.LIST_WIDTH}},r.a.createElement(d.a,{className:"list-header"},r.a.createElement(g.a,{className:"px-3 pt-3",style:{height:40}},r.a.createElement(v.a,{className:"d-flex flex-grow-1 p-0 logo-image align-items-center"},r.a.createElement("img",{height:22,src:a(230),alt:"BPIUM"})),r.a.createElement(v.a,{className:"exit p-0 m-0 flex-grow-0",onClick:this.props.exit},r.a.createElement("img",{height:20,src:a(231)}))),r.a.createElement(v.a,{className:"d-flex flex-wrap px-0 mx-0 pb-2 pt-3 align-content-center"},t)),r.a.createElement(L.a,null,function(t){var a=t.height,c=t.width;return r.a.createElement(L.b,{rowHeight:40,rowCount:e.props.data.length,rowRenderer:function(t){var a=t.index,n=t.key,c=t.style;return r.a.createElement("div",{key:n,style:c},r.a.createElement(U,{id:e.props.data[a].id,name:e.props.data[a].address,applications:e.props.data[a].applications,openFrame:e.props.openFrame}))},onRowsRendered:function(t){var a=t.startIndex,n=t.stopIndex;return e.setState({startIndex:a,stopIndex:n})},height:a-130-(n>0?30:0),width:c})}),r.a.createElement("canvas",{className:"blur-bottom-corner",ref:"bottomBlurer",hidden:n<=0,height:this.blurerHeight,width:this.props.view.LIST_WIDTH-4}),r.a.createElement(G,{count:n}))}}]),t}(r.a.Component),G=function(e){return e.count>0?r.a.createElement(v.a,{className:"remain-info w-100 px-3 m-0",style:{height:30}},"\u0438 \u0435\u0449\u0435 ".concat(e.count," \u043e\u0431\u044a\u0435\u043a\u0442\u043e\u0432...")):null},J=function(e){return r.a.createElement(v.a,{onMouseDown:function(e){return e.preventDefault()},onDoubleClick:function(e){return e.preventDefault()},onClick:function(){e.toggleFilterSelect(e.index)},className:"d-flex flex-wrap flex-grow-0 px-0 text-center"},r.a.createElement("div",{style:{backgroundColor:e.selected?e.colorMuted:null,color:e.color},className:"filter-title"},e.title))},U=function(e){var t={};e.applications.forEach(function(e){t[e.criticality]=t[e.criticality]?t[e.criticality]++:1});var a=[];for(var n in t)a.push(r.a.createElement(W,{key:n,count:t[n],colorMuted:M[n].colorMuted,color:M[n].color}));return r.a.createElement(d.a,{className:"p-0 mx-0"},r.a.createElement(g.a,{className:"list-item px-3 m-0 align-items-center",onClick:function(){return e.openFrame(e.id)}},r.a.createElement(v.a,{title:e.name,className:"flex-grow-1 name px-0 mx-0"},e.name),a))},W=function(e){return r.a.createElement(v.a,{className:"flex-grow-0 filter-item px-0 text-center",style:{backgroundColor:e.colorMuted,color:e.color}},e.count)},X=a(119),Y=a.n(X),K={LIST_WIDTH:350,FRAME_PX:70,FRAME_PY:30},V=function(e){function t(){var e,a;Object(u.a)(this,t);for(var n=arguments.length,r=new Array(n),c=0;c<n;c++)r[c]=arguments[c];return(a=Object(m.a)(this,(e=Object(h.a)(t)).call.apply(e,[this].concat(r)))).state={frameOpen:!1,recordId:null},a.openFrame=function(e){a.setState({frameOpen:!0,recordId:e})},a.closeFrame=function(){a.setState({frameOpen:!1,recordId:null})},a}return Object(f.a)(t,e),Object(p.a)(t,[{key:"render",value:function(){var e=r.a.createElement(q,Object.assign({key:"list"},this.props,{data:this.props.data.concat(this.props.data).concat(this.props.data).concat(this.props.data).concat(this.props.data).concat(this.props.data).concat(this.props.data),openFrame:this.openFrame,view:K}));return this.state.frameOpen?r.a.createElement(A.a,{fluid:!0,className:"Interface h-100 w-100 p-0 m-0"},r.a.createElement(Y.a,{className:"h-100 w-100 p-0 m-0"},r.a.createElement(B,{key:"frame",closeFrame:this.closeFrame,recordId:this.state.recordId,view:K}),e)):r.a.createElement("div",{className:"Interface frame-closed p-0 m-0 h-100"},e)}}]),t}(r.a.Component),Z="https://cors-anywhere.herokuapp.com/https://megapolis.bpium.ru/api/v1",Q=function(e,t){return $.apply(this,arguments)};function $(){return($=Object(l.a)(i.a.mark(function e(t,a){var n,r;return i.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n={"Content-Type":"application/json"},a&&(n.Authorization="Basic "+btoa("".concat(a.email,":").concat(a.password))),e.next=4,fetch(Z+t,{method:"GET",headers:n});case 4:return r=e.sent,e.abrupt("return",r);case 6:case"end":return e.stop()}},e)}))).apply(this,arguments)}var ee=a(120),te="https://cors-anywhere.herokuapp.com/https://megapolis.bpium.ru/api/v1",ae=function(e,t,a,n){return ne.apply(this,arguments)};function ne(){return(ne=Object(l.a)(i.a.mark(function e(t,a,n,r){var c,s,o;return i.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return c={"Content-Type":"application/json"},r&&(c.Authorization="Basic "+btoa("".concat(r.email,":").concat(r.password))),(s={values:{}}).values[a]=n,e.next=6,fetch(te+t,{method:"PATCH",headers:c,body:JSON.stringify(s)});case 6:return o=e.sent,e.abrupt("return",o);case 8:case"end":return e.stop()}},e)}))).apply(this,arguments)}var re=new window.google.maps.Geocoder,ce=function(e,t){return se.apply(this,arguments)};function se(){return(se=Object(l.a)(i.a.mark(function e(t,a){var n,r,c,s;return i.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return console.log(t),n={},r=[],t.branches.forEach(function(e){var t=e.id,c=e.values[6],s=e.values[20],o=[];if(s){var u=s.split(",").map(function(e){return+e}),p=Object(ee.a)(u,2),m=p[0],h=p[1];n[t]={address:c,lat:m,lng:h,applications:o}}else r.push(new Promise(function(e,r){re.geocode({address:c,region:"ru"},function(){var r=Object(l.a)(i.a.mark(function r(s,l){var u,p,m,h;return i.a.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:if("OK"!==l){r.next=15;break}if(u=s[0].geometry.location.lat(),p=s[0].geometry.location.lng(),"ROOFTOP"!==(m=s[0].geometry.location_type)&&"RANGE_INTERPOLATED"!==m){r.next=12;break}return n[t]={address:c,lat:u,lng:p,applications:o},r.next=8,ae("/catalogs/12/records/".concat(t),"20","".concat(u,",").concat(p),a);case 8:h=r.sent,console.log(c," coords writing: ",h.status),r.next=13;break;case 12:console.log("Incorrect address "+c+" skipped, id ",t);case 13:r.next=16;break;case 15:console.log("Error: ",c,l);case 16:e();case 17:case"end":return r.stop()}},r)}));return function(e,t){return r.apply(this,arguments)}}())}))}),e.next=6,Promise.all(r);case 6:for(s in t.applications.forEach(function(e){var t=e.values[3][0].recordId,a=+e.values[5][0],r=+e.values[10][0];n[t]&&n[t].applications.push({status:a,criticality:r})}),c=[],n)n[s].id=s,c.push(n[s]);return e.abrupt("return",c);case 10:case"end":return e.stop()}},e)}))).apply(this,arguments)}function oe(e,t){var a=[];return e.forEach(function(e){var n=[];if(e.applications.length||!~t.criticality.indexOf("default")){var r=function(a){e.applications.forEach(function(e){~t[a].indexOf(""+e[a])&&n.push(e)})};for(var c in t)r(c);n.length&&((e=Object.assign({},e)).applications=n,a.push(e))}else a.push(Object.assign({},e))}),a}a(232),a(233);var ie=function(e){function t(){var e,a;Object(u.a)(this,t);for(var n=arguments.length,r=new Array(n),c=0;c<n;c++)r[c]=arguments[c];return(a=Object(m.a)(this,(e=Object(h.a)(t)).call.apply(e,[this].concat(r)))).state={authRequired:!0,error:!1,waiting:!1,data:null,filteredData:null},a.exit=function(){a.setState({authRequired:!0,data:null,filteredData:null})},a.filterData=function(e){a.setState({filteredData:oe(a.state.data,e)},function(){return console.log("filtered data:",a.state.filteredData)})},a}return Object(f.a)(t,e),Object(p.a)(t,[{key:"componentDidMount",value:function(){this.checkAccess()}},{key:"onAuthSuccess",value:function(e){this.getData(e)}},{key:"checkAccess",value:function(){var e=Object(l.a)(i.a.mark(function e(){var t;return i.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.setState({waiting:!0}),e.next=3,Q("");case 3:404===(t=e.sent).status?this.onAuthSuccess():401===t.status?this.setState({waiting:!1}):this.onError(t);case 5:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"getData",value:function(){var e=Object(l.a)(i.a.mark(function e(t){var a,n,r;return i.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=Object.assign({},t),this.setState({waiting:!0}),e.next=4,Q("/catalogs/12/records",t);case 4:return e.t0=e.sent,e.next=7,Q("/catalogs/11/records",t);case 7:e.t1=e.sent,a={branches:e.t0,applications:e.t1},e.t2=i.a.keys(a);case 10:if((e.t3=e.t2()).done){e.next=22;break}if(n=e.t3.value,200!==a[n].status){e.next=18;break}return e.next=15,a[n].json();case 15:a[n]=e.sent,e.next=20;break;case 18:return this.onError(a[n]),e.abrupt("return");case 20:e.next=10;break;case 22:return e.next=24,ce(a,t);case 24:r=e.sent,this.setState({authRequired:!1,data:r,filteredData:r,waiting:!1}),console.log("data:",this.state.data);case 27:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"onError",value:function(e){this.setState({error:e})}},{key:"render",value:function(){var e=this,t=!this.state.waiting&&this.state.authRequired?r.a.createElement(N,{key:"auth",onAuthSuccess:function(t){return e.onAuthSuccess(t)}}):null,a=this.state.waiting?r.a.createElement(w,{key:"waiter"}):null,n=r.a.createElement(R,{key:"map",data:this.state.filteredData}),c=[a,t,this.state.filteredData?r.a.createElement(V,{key:"interface",data:this.state.filteredData,filterData:this.filterData,exit:this.exit}):null,n];return this.state.error&&(c=r.a.createElement(le,{res:this.state.error})),c}}]),t}(n.Component),le=function(e){return r.a.createElement("div",null,"".concat(e.res.status," ").concat(e.res.statusText))};s.a.render(r.a.createElement(ie,null),document.getElementById("root"))}},[[121,1,2]]]);
//# sourceMappingURL=main.05d2a884.chunk.js.map